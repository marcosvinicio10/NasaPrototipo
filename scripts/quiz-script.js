// Script espec√≠fico para a p√°gina do quiz
class QuizApp {
    constructor() {
        this.questions = [];
        this.currentQuestion = 0;
        this.score = 0;
        this.correctAnswers = 0;
        this.startTime = null;
        this.selectedAnswer = null;
        this.quizCompleted = false;
        
        this.init();
    }

    init() {
        console.log('Inicializando aplica√ß√£o do quiz...');
        this.loadQuestions();
        this.setupEventListeners();
        this.startQuiz();
    }

    loadQuestions() {
        this.questions = [
            {
                id: 1,
                question: "Imagine que voc√™ est√° caminhando na rua e sente que o ar est√° 'pesado' e dif√≠cil de respirar. Qual √© o poluente invis√≠vel que mais provavelmente est√° causando essa sensa√ß√£o?",
                category: "üå¨Ô∏è Experi√™ncia Pessoal",
                options: [
                    "Di√≥xido de Carbono (CO‚ÇÇ) - o g√°s que expiramos",
                    "Material Particulado (PM2.5) - part√≠culas microsc√≥picas que entram nos pulm√µes",
                    "Oxig√™nio (O‚ÇÇ) - o g√°s que respiramos",
                    "Nitrog√™nio (N‚ÇÇ) - o g√°s mais abundante no ar"
                ],
                correct: 1,
                explanation: "O PM2.5 s√£o part√≠culas t√£o pequenas que penetram profundamente nos pulm√µes, causando aquela sensa√ß√£o de 'ar pesado' e dificuldade para respirar. √â como respirar poeira invis√≠vel!"
            },
            {
                id: 2,
                question: "Voc√™ est√° planejando uma atividade ao ar livre para sua fam√≠lia. Qual valor de qualidade do ar voc√™ consideraria seguro para crian√ßas brincarem no parque?",
                category: "üë®‚Äçüë©‚Äçüëß‚Äçüë¶ Prote√ß√£o Familiar",
                options: [
                    "0-50 (Verde) - Ar limpo e seguro para todos",
                    "51-100 (Amarelo) - Aceit√°vel, mas sens√≠veis devem ter cuidado",
                    "101-150 (Laranja) - Insalubre para grupos sens√≠veis",
                    "151-200 (Vermelho) - Insalubre para todos"
                ],
                correct: 0,
                explanation: "Valores 0-50 (Verde) s√£o os √∫nicos considerados seguros para atividades ao ar livre, especialmente para crian√ßas, idosos e pessoas com problemas respirat√≥rios. √â quando voc√™ pode respirar fundo sem se preocupar!"
            },
            {
                id: 3,
                question: "Sua av√≥ de 75 anos est√° preocupada com a qualidade do ar em sua cidade. Qual √© o impacto mais comum da polui√ß√£o do ar na sa√∫de de idosos?",
                category: "üëµ Impacto na Terceira Idade",
                options: [
                    "Melhora da capacidade pulmonar",
                    "Aumento do risco de infartos e derrames",
                    "Fortalecimento do sistema imunol√≥gico",
                    "Redu√ß√£o da press√£o arterial"
                ],
                correct: 1,
                explanation: "A polui√ß√£o do ar aumenta significativamente o risco de problemas cardiovasculares em idosos, incluindo infartos e derrames. √â por isso que dias de ar polu√≠do s√£o especialmente perigosos para nossos av√≥s."
            },
            {
                id: 4,
                question: "Voc√™ est√° dirigindo para o trabalho todos os dias e se preocupa com sua contribui√ß√£o para a polui√ß√£o. Qual a√ß√£o di√°ria teria o maior impacto positivo na qualidade do ar?",
                category: "üöó A√ß√£o Pessoal",
                options: [
                    "Usar o ar-condicionado do carro menos",
                    "Optar por transporte p√∫blico ou bicicleta 2-3 vezes por semana",
                    "Trocar o filtro de ar do carro mensalmente",
                    "Dirigir mais devagar para economizar combust√≠vel"
                ],
                correct: 1,
                explanation: "Reduzir o uso do carro individual √© a a√ß√£o mais impactante. Cada viagem que voc√™ faz de √¥nibus, metr√¥ ou bicicleta significa menos poluentes no ar que todos respiramos!"
            },
            {
                id: 5,
                question: "Refletindo sobre o que voc√™ aprendeu no AirQuest, quantas pessoas no mundo respiram ar que n√£o atende aos padr√µes seguros da OMS?",
                category: "üåç Consci√™ncia Global",
                options: [
                    "1 em cada 10 pessoas (10%)",
                    "1 em cada 4 pessoas (25%)",
                    "9 em cada 10 pessoas (90%)",
                    "Todas as pessoas (100%)"
                ],
                correct: 2,
                explanation: "Incrivelmente, 9 em cada 10 pessoas no mundo respiram ar que n√£o atende aos padr√µes seguros da OMS. Isso significa que quase todos n√≥s, incluindo voc√™ e sua fam√≠lia, estamos expostos a n√≠veis perigosos de polui√ß√£o do ar."
            }
        ];
        
        console.log(`${this.questions.length} quest√µes carregadas`);
    }

    setupEventListeners() {
        // Event listeners para bot√µes de resposta
        document.addEventListener('click', (e) => {
            if (e.target.classList.contains('answer-option')) {
                this.selectAnswer(parseInt(e.target.dataset.index));
            }
        });

        // Event listeners para bot√µes de controle
        const nextBtn = document.getElementById('next-btn');
        const skipBtn = document.getElementById('skip-btn');
        
        if (nextBtn) {
            nextBtn.addEventListener('click', (e) => {
                e.preventDefault();
                this.nextQuestion();
            });
        }
        
        if (skipBtn) {
            skipBtn.addEventListener('click', (e) => {
                e.preventDefault();
                this.skipQuestion();
            });
        }
    }

    startQuiz() {
        console.log('Iniciando quiz...');
        this.currentQuestion = 0;
        this.score = 0;
        this.correctAnswers = 0;
        this.startTime = Date.now();
        this.quizCompleted = false;
        this.selectedAnswer = null;
        
        this.showQuestion();
        this.updateProgress();
    }

    showQuestion() {
        if (this.currentQuestion >= this.questions.length) {
            this.showResults();
            return;
        }

        const question = this.questions[this.currentQuestion];
        console.log(`Mostrando quest√£o ${this.currentQuestion + 1}: ${question.question}`);
        
        // Atualizar elementos da interface
        document.getElementById('question-text').textContent = question.question;
        document.getElementById('question-category').textContent = question.category;
        
        // Criar op√ß√µes de resposta
        const answersContainer = document.getElementById('answers-container');
        answersContainer.innerHTML = '';
        
        question.options.forEach((option, index) => {
            const answerElement = document.createElement('div');
            answerElement.className = 'answer-option';
            answerElement.dataset.index = index;
            answerElement.innerHTML = `
                <span class="option-letter">${String.fromCharCode(65 + index)}</span>
                <span class="option-text">${option}</span>
            `;
            answersContainer.appendChild(answerElement);
        });
        
        // Resetar sele√ß√£o e estado
        this.selectedAnswer = null;
        this.quizCompleted = false;
        this.updateNextButton();
    }

    selectAnswer(answerIndex) {
        console.log(`Resposta selecionada: ${answerIndex}`);
        
        // Remover sele√ß√£o anterior
        document.querySelectorAll('.answer-option').forEach(option => {
            option.classList.remove('selected');
        });
        
        // Marcar nova sele√ß√£o
        const selectedOption = document.querySelector(`[data-index="${answerIndex}"]`);
        if (selectedOption) {
            selectedOption.classList.add('selected');
        }
        
        this.selectedAnswer = answerIndex;
        this.updateNextButton();
    }

    updateNextButton() {
        const nextBtn = document.getElementById('next-btn');
        if (nextBtn) {
            nextBtn.disabled = this.selectedAnswer === null || this.quizCompleted;
        }
    }

    nextQuestion() {
        if (this.selectedAnswer === null || this.quizCompleted) {
            console.log('Pr√≥xima pergunta bloqueada - sem resposta ou j√° processada');
            return;
        }
        
        // Prevenir m√∫ltiplas execu√ß√µes
        this.quizCompleted = true;
        
        const question = this.questions[this.currentQuestion];
        const isCorrect = this.selectedAnswer === question.correct;
        
        console.log(`Pergunta ${this.currentQuestion + 1}: Resposta ${isCorrect ? 'Correta' : 'Incorreta'} (${this.correctAnswers} corretas at√© agora)`);
        
        if (isCorrect) {
            this.correctAnswers++;
            this.score += 100;
            console.log(`Acerto! Total: ${this.correctAnswers} corretas, ${this.score} pontos`);
        }
        
        // Mostrar feedback visual
        this.showAnswerFeedback(isCorrect);
        
        // Avan√ßar para pr√≥xima quest√£o ap√≥s delay
        setTimeout(() => {
            this.currentQuestion++;
            this.quizCompleted = false; // Reativar para pr√≥xima pergunta
            this.updateProgress();
            this.showQuestion();
        }, 1500);
    }

    showAnswerFeedback(isCorrect) {
        const selectedOption = document.querySelector(`[data-index="${this.selectedAnswer}"]`);
        if (selectedOption) {
            selectedOption.classList.add(isCorrect ? 'correct' : 'incorrect');
        }
        
        // Destacar resposta correta
        const correctOption = document.querySelector(`[data-index="${this.questions[this.currentQuestion].correct}"]`);
        if (correctOption && !isCorrect) {
            correctOption.classList.add('correct');
        }
    }

    skipQuestion() {
        console.log('Quest√£o pulada');
        this.currentQuestion++;
        this.updateProgress();
        this.showQuestion();
    }

    updateProgress() {
        const progress = (this.currentQuestion / this.questions.length) * 100;
        document.getElementById('quiz-progress').style.width = `${progress}%`;
        document.getElementById('question-counter').textContent = `${this.currentQuestion + 1} de ${this.questions.length}`;
    }

    showResults() {
        console.log('Mostrando resultados...');
        this.quizCompleted = true;
        
        const endTime = Date.now();
        const totalTime = Math.round((endTime - this.startTime) / 1000);
        
        // Garantir que os valores sejam v√°lidos
        const validCorrectAnswers = Math.max(0, Math.min(this.correctAnswers, this.questions.length));
        const accuracy = this.questions.length > 0 ? Math.round((validCorrectAnswers / this.questions.length) * 100) : 0;
        const finalScore = validCorrectAnswers * 100;
        
        console.log(`Resultados: ${validCorrectAnswers}/${this.questions.length} corretas, ${accuracy}% de precis√£o, ${finalScore} pontos`);
        
        // Atualizar elementos de resultado
        document.getElementById('final-score').textContent = finalScore;
        document.getElementById('correct-answers').textContent = `${validCorrectAnswers}/${this.questions.length}`;
        document.getElementById('accuracy').textContent = `${accuracy}%`;
        document.getElementById('quiz-time').textContent = `${totalTime}s`;
        
        // Determinar medalha
        const medal = this.calculateMedal(accuracy);
        this.showMedal(medal);
        
        // Atualizar estat√≠sticas
        this.updateStats();
        
        // Mostrar tela de resultados
        document.getElementById('question-container').style.display = 'none';
        document.getElementById('results-screen').style.display = 'block';
    }

    calculateMedal(accuracy) {
        if (accuracy >= 90) {
            return { icon: 'ü•á', name: 'Ouro', description: 'Excelente! Voc√™ √© um especialista em qualidade do ar!' };
        } else if (accuracy >= 70) {
            return { icon: 'ü•à', name: 'Prata', description: 'Muito bom! Continue aprendendo sobre qualidade do ar!' };
        } else if (accuracy >= 50) {
            return { icon: 'ü•â', name: 'Bronze', description: 'Bom come√ßo! Continue estudando para melhorar!' };
        } else {
            return { icon: 'üìö', name: 'Estudante', description: 'Continue estudando! O conhecimento sobre qualidade do ar √© importante!' };
        }
    }

    showMedal(medal) {
        document.querySelector('.medal-icon').textContent = medal.icon;
        document.querySelector('.medal-text').textContent = medal.name;
        document.getElementById('medal-description').textContent = medal.description;
    }

    updateStats() {
        // Atualizar estat√≠sticas locais (implementa√ß√£o simplificada)
        const stats = this.getStats();
        document.getElementById('streak').textContent = stats.streak;
        document.getElementById('best-score').textContent = stats.bestScore;
        document.getElementById('total-quizzes').textContent = stats.totalQuizzes;
    }

    getStats() {
        // Recuperar estat√≠sticas do localStorage
        const stats = JSON.parse(localStorage.getItem('quizStats') || '{"streak": 0, "bestScore": 0, "totalQuizzes": 0}');
        
        // Atualizar estat√≠sticas
        stats.totalQuizzes++;
        if (this.score > stats.bestScore) {
            stats.bestScore = this.score;
        }
        if (this.correctAnswers === this.questions.length) {
            stats.streak++;
        } else {
            stats.streak = 0;
        }
        
        // Salvar estat√≠sticas
        localStorage.setItem('quizStats', JSON.stringify(stats));
        
        return stats;
    }

    restartQuiz() {
        console.log('Reiniciando quiz...');
        document.getElementById('results-screen').style.display = 'none';
        document.getElementById('question-container').style.display = 'block';
        
        // Reset completo de todas as vari√°veis
        this.currentQuestion = 0;
        this.score = 0;
        this.correctAnswers = 0;
        this.startTime = Date.now();
        this.quizCompleted = false;
        this.selectedAnswer = null;
        
        this.showQuestion();
        this.updateProgress();
    }
}

// Fun√ß√µes globais para os bot√µes
function nextQuestion() {
    if (window.quizApp) {
        window.quizApp.nextQuestion();
    }
}

function skipQuestion() {
    if (window.quizApp) {
        window.quizApp.skipQuestion();
    }
}

function restartQuiz() {
    if (window.quizApp) {
        window.quizApp.restartQuiz();
    }
}

// Inicializar aplica√ß√£o quando a p√°gina carregar
document.addEventListener('DOMContentLoaded', () => {
    console.log('P√°gina do quiz carregada');
    window.quizApp = new QuizApp();
});
